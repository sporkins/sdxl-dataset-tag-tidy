{% extends "base.html" %}
{% block title %}Image {{ image.image_id[:6] }}{% endblock %}
{% block content %}
<section class="stack">
    <a class="secondary button" href="/dataset">Back to dataset</a>
    <div class="card stack">
        <div class="row" style="justify-content: space-between; align-items: center;">
            <div class="row" style="gap:0.5rem;">
                {% if neighbors.previous %}
                <a class="secondary button" href="/image/{{ neighbors.previous }}">← Previous</a>
                {% endif %}
                {% if neighbors.next %}
                <a class="secondary button" href="/image/{{ neighbors.next }}">Next →</a>
                {% endif %}
            </div>
            <form class="row" style="gap:0.35rem;" hx-post="/api/image/{{ image.image_id }}/complete" hx-swap="none" hx-on::after-request="handleCompletionToggle(event)">
                <input type="hidden" name="complete" value="{{ not image.is_complete }}">
                <button type="submit" class="secondary" style="width:auto;">{% if image.is_complete %}Mark incomplete{% else %}Mark complete{% endif %}</button>
                <span id="completion-badge" class="badge {% if image.is_complete %}success{% endif %}">{% if image.is_complete %}Complete{% else %}Incomplete{% endif %}</span>
            </form>
        </div>
        <div class="row wrap" style="gap:1rem;">
            <div style="flex:2; min-width:220px;">
                <img src="/img/full/{{ image.image_id }}" alt="{{ image.rel_path }}" style="width:100%; border-radius:12px;">
                <div class="small">{{ image.rel_path }}</div>
            </div>
            <div style="flex:1; min-width:220px;" class="stack">
                <div class="small">Hints</div>
                <div class="stack" style="gap:0.5rem;" id="hints-complete" {% if not image.is_complete %}hidden{% endif %}>
                    <div class="badge success">Complete — hints hidden</div>
                </div>
                <div class="stack" style="gap:0.5rem;" id="hints-active" {% if image.is_complete %}hidden{% endif %}>
                    {% for category in hints.missing_required %}
                    {% set slug = category.replace(' ', '-') %}
                    <div id="hint-{{ slug }}" class="row wrap" style="gap:0.5rem; align-items:center;">
                        <div class="badge error">Missing: {{ category }}</div>
                        <button type="button" class="secondary" style="width:auto;" hx-get="/api/image/{{ image.image_id }}/hint-options?category={{ category | urlencode }}&hint_type=missing" hx-target="#hint-{{ slug }}" hx-swap="outerHTML">Choose</button>
                    </div>
                    {% endfor %}
                    {% for category in hints.possibly_missing %}
                    {% set slug = category.replace(' ', '-') %}
                    <div id="hint-{{ slug }}" class="row wrap" style="gap:0.5rem; align-items:center;">
                        <div class="badge warn">Possible: {{ category }}</div>
                        <button type="button" class="secondary" style="width:auto;" hx-get="/api/image/{{ image.image_id }}/hint-options?category={{ category | urlencode }}&hint_type=possible" hx-target="#hint-{{ slug }}" hx-swap="outerHTML">Choose</button>
                    </div>
                    {% endfor %}
                    {% if hints.not_required %}
                    <div class="badge">Not required: {{ hints.not_required | join(', ') }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="card stack">
        <div class="row" style="justify-content: space-between; align-items: center;">
            <div>
                <div class="small">Tags (drag to reorder)</div>
                <div id="reorder-status" class="small"></div>
            </div>
            <div class="stack" style="gap:0.35rem;">
                <form hx-post="/api/image/{{ image.image_id }}/ops" hx-target="#tag-feedback" hx-on::after-request="location.reload()" class="stack" style="gap:0.35rem;">
                    <input type="hidden" name="type" value="add">
                    <div class="row wrap">
                        <input name="tag" placeholder="new tag" />
                        <button type="submit" class="secondary" style="width:auto;">Add</button>
                    </div>
                </form>
                <div class="row wrap" style="align-items:center;">
                    <button type="button" class="secondary" style="width:auto;" hx-get="/api/image/{{ image.image_id }}/analyze" hx-target="#analysis-results" hx-swap="innerHTML" hx-indicator="#analyze-loading">Analyze</button>
                    <div id="analyze-loading" class="small htmx-indicator">Analyzing…</div>
                </div>
            </div>
        </div>
        <ul id="tag-list" class="stack" data-sortable="tags" data-image-id="{{ image.image_id }}" style="list-style:none; padding-left:0; gap:0.35rem;">
            {% for tag in image.tags_current %}
            <li data-tag-value="{{ tag }}" data-tag-index="{{ loop.index0 }}" class="tag {% if tag|lower in undesired_tags %}danger{% endif %}">
                <button type="button" class="secondary drag-handle" aria-label="Reorder tag" style="width:auto; margin-right:0.35rem;">↕</button>
                <span>{{ tag }}</span>
                <button type="button" class="secondary edit-tag-btn" data-image-id="{{ image.image_id }}" data-index="{{ loop.index0 }}" data-current-value="{{ tag }}" aria-label="Edit tag" style="width:auto; margin-left:0.35rem;">✎</button>
                <form hx-post="/api/image/{{ image.image_id }}/ops" hx-target="#tag-feedback" hx-on::after-request="location.reload()" style="margin-left:0.35rem; width:auto; display:inline;">
                    <input type="hidden" name="type" value="delete">
                    <input type="hidden" name="tag" value="{{ tag }}">
                    <button type="submit" class="secondary" style="width:auto;">✕</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        <div id="tag-feedback" class="small"></div>
        <div id="analysis-results" class="stack"></div>
    </div>
</section>
{% endblock %}
